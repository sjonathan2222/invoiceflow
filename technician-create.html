<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Invoice â€” Technician</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h2 class="text-xl font-semibold">Create Invoice</h2>
      <div>
        <a href="technician-dashboard.html" class="text-sm text-indigo-600 hover:underline">Back to Dashboard</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6">
    <form id="invoiceForm" class="bg-white rounded-xl shadow p-6 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Customer Name</label>
          <input id="customer" required class="mt-1 block w-full rounded-md border-gray-200 p-2" placeholder="Customer or company name">
        </div>
        <div>
          <label class="block text-sm font-medium">Invoice Date</label>
          <input id="invDate" type="date" class="mt-1 block w-full rounded-md border-gray-200 p-2">
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium">Items</label>
        <div class="mt-2 bg-gray-50 border rounded-md p-3">
          <table class="w-full text-sm" id="itemsTable">
            <thead>
              <tr class="text-left text-gray-600">
                <th class="py-2">Description</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="itemsBody">
              <!-- rows -->
            </tbody>
          </table>
          <div class="mt-3">
            <button id="addRow" type="button" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700">+ Add item</button>
            <button id="saveDraft" type="button" class="ml-2 bg-gray-200 px-3 py-1 rounded-md">Save draft</button>
            <button id="submitInv" type="button" class="ml-2 bg-indigo-600 text-white px-3 py-1 rounded-md">Submit for approval</button>
          </div>
        </div>
      </div>

      <div class="flex justify-end items-center gap-6">
        <div class="text-right">
          <p class="text-sm text-gray-500">Total</p>
          <p id="totalAmount" class="text-2xl font-semibold">0.00</p>
        </div>
      </div>
    </form>
  </main>

  <script>
    // set default date to today
    const dateInput = document.getElementById('invDate');
    const today = new Date();
    dateInput.value = today.toISOString().slice(0,10);

    const itemsBody = document.getElementById('itemsBody');
    const totalAmountEl = document.getElementById('totalAmount');

    function createRow(item = {desc:'', qty:1, price:0}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="py-2"><input class="w-full p-2 rounded border-gray-200 desc" value="${item.desc}"></td>
        <td><input type="number" min="0" class="w-20 p-2 rounded border-gray-200 qty" value="${item.qty}"></td>
        <td><input type="number" min="0" step="0.01" class="w-28 p-2 rounded border-gray-200 price" value="${item.price}"></td>
        <td class="subtotal text-right font-medium pr-2">0.00</td>
        <td class="text-right"><button class="remove text-sm text-red-600">Remove</button></td>
      `;
      // attach events
      tr.querySelectorAll('.qty, .price').forEach(el=>{
        el.addEventListener('input', updateTotals);
      });
      tr.querySelector('.remove').addEventListener('click', e=>{
        e.preventDefault();
        tr.remove();
        updateTotals();
      });
      itemsBody.appendChild(tr);
      updateTotals();
    }

    document.getElementById('addRow').addEventListener('click', ()=>createRow());
    // start with one row
    createRow({desc:'Service / item', qty:1, price:0});

    function updateTotals(){
      let total = 0;
      itemsBody.querySelectorAll('tr').forEach(row=>{
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const price = parseFloat(row.querySelector('.price').value) || 0;
        const subtotal = qty * price;
        row.querySelector('.subtotal').textContent = subtotal.toFixed(2);
        total += subtotal;
      });
      totalAmountEl.textContent = total.toFixed(2);
    }

    // basic validation: no empty customer name and at least one item
    function collectInvoice(){
      const customer = document.getElementById('customer').value.trim();
      if(!customer) return {error:'Customer name required.'};
      const items = [];
      itemsBody.querySelectorAll('tr').forEach(row=>{
        const desc = row.querySelector('.desc').value.trim();
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const price = parseFloat(row.querySelector('.price').value) || 0;
        if(desc && qty > 0 && price >= 0) items.push({desc,qty,price,subtotal: qty*price});
      });
      if(items.length === 0) return {error:'Add at least one valid item.'};
      const total = items.reduce((s,i)=>s+i.subtotal,0);
      return {customer, date:dateInput.value, items, total};
    }

    document.getElementById('saveDraft').addEventListener('click', ()=> {
      const data = collectInvoice();
      if(data.error){ alert(data.error); return;}
      // demo: persist to localStorage drafts
      const drafts = JSON.parse(localStorage.getItem('invoiceDrafts')||'[]');
      drafts.push({...data, status:'Draft', id: 'DRAFT-'+Date.now()});
      localStorage.setItem('invoiceDrafts', JSON.stringify(drafts));
      alert('Draft saved (local demo).');
    });

    document.getElementById('submitInv').addEventListener('click', ()=> {
      const data = collectInvoice();
      if(data.error){ alert(data.error); return;}
      // demo: persist to localStorage pending list
      const pending = JSON.parse(localStorage.getItem('pendingInvoices')||'[]');
      pending.push({...data, status:'Pending', id: 'INV-'+Date.now()});
      localStorage.setItem('pendingInvoices', JSON.stringify(pending));
      alert('Invoice submitted for approval (demo). Redirecting to dashboard.');
      location.href = 'technician-dashboard.html';
    });
  </script>
</body>
</html>
